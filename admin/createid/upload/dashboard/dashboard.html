<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafeID Dashboard</title>
  <link rel="icon" type="image/png" href="./assets/images/safeidlogo.png">
  <style>
    /* --- Global Styles --- */
    :root {
      --primary-color: #1a73e8;
      --secondary-color: #f4f7fb;
      --text-dark: #333;
      --text-light: #fff;
      --card-bg: #fff;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    body { background: var(--secondary-color); color: var(--text-dark); line-height: 1.6; }

    /* --- Navbar --- */
    .navbar { background: var(--primary-color); padding: 15px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .nav-container { max-width: 1100px; margin: auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .logo { color: var(--text-light); font-weight: bold; font-size: 24px; }
    .nav-links { list-style: none; display: flex; gap: 25px; }
    .nav-links li a { text-decoration: none; color: var(--text-light); font-weight: 500; transition: 0.3s; }
    .nav-links li a:hover, .nav-links li a.active { color: #ffdd57; }

    /* --- Hero Section --- */
    .hero { background: var(--primary-color); color: var(--text-light); text-align: center; padding: 40px 20px; }
    .hero-content { max-width: 800px; margin: auto; }
    .user-photo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--text-light); object-fit: cover; margin-bottom: 15px; background: #fff; }
    .hero h1 { font-size: 2.5rem; }
    .hero p { font-size: 1.1rem; opacity: 0.9; }

    /* --- Sections & Cards --- */
    .info-section { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    .info-section h2 { font-size: 1.8rem; color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    .info-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
    .info-card p { font-size: 1rem; margin-bottom: 10px; }
    .info-card p strong { color: #555; }
    .info-card span { word-break: break-all; }

    /* --- Documents Table --- */
    .documents-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .documents-table thead { background: #e9ecef; }
    .documents-table th, .documents-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
    .documents-table th { font-weight: 600; }
    .status-verified { color: #28a745; font-weight: bold; }
    .document-link { color: var(--primary-color); text-decoration: none; font-weight: 500; }
    .document-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">SafeID</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="dashboard.html" class="active">Dashboard</a></li>
        <li><a href="upload.html">Upload</a></li>
      </ul>
    </div>
  </nav>

  <!-- Hero / Welcome Section -->
  <header class="hero">
    <div class="hero-content">
      <!-- The src of this image will be set by the script -->
      <img src="https://via.placeholder.com/100" alt="User Photo" class="user-photo" id="userPhoto">
      <h1>Welcome, <span id="userName">[Refugee Name]</span> üôè</h1>
      <p>Your decentralized identity dashboard</p>
    </div>
  </header>

  <!-- User Info -->
  <section class="info-section">
    <h2>Profile Information</h2>
    <div class="info-card">
      <p><strong>Name:</strong> <span id="profileName"></span></p>
      <p><strong>Email:</strong> <span id="profileEmail"></span></p>
      <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
      <p><strong>Nationality:</strong> <span id="profileNationality"></span></p>
      <p><strong>Wallet Address:</strong> <span id="profileWallet"></span></p>
    </div>
  </section>

  <!-- Documents Section -->
  <section class="info-section">
    <h2>Uploaded Documents</h2>
    <div class="info-card">
      <table class="documents-table" id="docsTable">
        <thead>
          <tr>
            <th>Document Type</th>
            <th>File on IPFS</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamic rows will be inserted here -->
        </tbody>
      </table>
    </div>
  </section>

  <script>
    // --- IPFS GATEWAY ---
    const IPFS_GATEWAY = 'https://gateway.pinata.cloud/ipfs/';

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      // Get all the data passed from the previous pages via URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const name = urlParams.get('name') || 'User';
      const email = urlParams.get('email') || 'N/A';
      const phone = urlParams.get('phno') || 'N/A';
      const nationality = urlParams.get('nationality') || 'N/A';
      const wallet = urlParams.get('wallet') || '[Not Provided]';
      const initialCid = urlParams.get('cid'); // The CID of the main identity folder
      const newDocCid = urlParams.get('newDocCid'); // The CID of the newly uploaded document
      const newDocType = urlParams.get('docType');
      const foldername = urlParams.get('foldername') ? `/${urlParams.get('foldername')}` : '';

      // --- Populate the Dashboard ---
      populateProfile(name, email, phone, nationality, wallet);
      fetchAndDisplayPhoto(initialCid, foldername);
      populateDocumentsTable(initialCid, newDocCid, newDocType);
    });

    /**
     * Populates the static profile information from the URL parameters.
     */
    function populateProfile(name, email, phone, nationality, wallet) {
      document.getElementById('userName').textContent = name;
      document.getElementById('profileName').textContent = name;
      document.getElementById('profileEmail').textContent = email;
      document.getElementById('profilePhone').textContent = phone;
      document.getElementById('profileNationality').textContent = nationality;
      document.getElementById('profileWallet').textContent = wallet;
    }

    /**
     * Fetches the refugee's photo from the IPFS directory and displays it.
     */
    async function fetchAndDisplayPhoto(cid, foldername) {
      if (!cid) return; // Don't try to fetch if there's no main CID

      const userPhoto = document.getElementById('userPhoto');
      // Construct the full URL to the photo inside the IPFS directory
      const photoUrl = `${IPFS_GATEWAY}${cid}${foldername}/photo.jpeg`;
      
      console.log(`Fetching photo from: ${photoUrl}`);
      userPhoto.src = photoUrl;
    }
    
    /**
     * Populates the documents table with the records.
     */
    function populateDocumentsTable(initialCid, newDocCid, newDocType) {
        const tableBody = document.querySelector('#docsTable tbody');
        tableBody.innerHTML = ''; // Clear any existing rows

        // Row for the main identity record (photo + details)
        if(initialCid) {
            const mainRow = tableBody.insertRow();
            mainRow.innerHTML = `
                <td>Initial Identity Record</td>
                <td><a href="${IPFS_GATEWAY}${initialCid}" target="_blank" class="document-link">View Files</a></td>
                <td class="status-verified">Verified on IPFS</td>
            `;
        }
        
        // Row for the newly uploaded document (if it exists)
        if (newDocCid) {
            const newDocRow = tableBody.insertRow();
            newDocRow.innerHTML = `
                <td>${formatDocType(newDocType)}</td>
                <td><a href="${IPFS_GATEWAY}${newDocCid}" target="_blank" class="document-link">View File</a></td>
                <td class="status-verified">Verified on IPFS</td>
            `;
        }
    }
    
    /**
     * A helper function to make document types look nice.
     */
    function formatDocType(docType) {
        if (!docType) return 'Document';
        return docType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Capitalizes words
    }

  </script>
</body>
</html>

