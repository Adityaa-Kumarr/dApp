<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Documents - SafeID</title>
<link rel="icon" type="image/png" href="./assets/images/safeidlogo.png">
<!-- Coinbase Embedded Wallet SDK -->
<script src="https://pay.coinbase.com/pay-sdk.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
  body { background: #f4f7fb; color: #333; line-height: 1.6; }

  /* --- NAVBAR --- */
  .navbar { background: #1a73e8; padding: 15px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .nav-container { max-width: 1100px; margin: auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
  .logo-img { width: 120px; border-radius: 8px; }
  .nav-links { list-style: none; display: flex; gap: 25px; }
  .nav-links li a { text-decoration: none; color: #fff; font-weight: 500; transition: 0.3s; }
  .nav-links li a:hover, .nav-links li a.active { color: #ffdd57; }

  /* --- UPLOAD SECTION --- */
  .upload-section { display: flex; justify-content: center; align-items: center; padding: 60px 20px; }
  .upload-card { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 550px; width: 100%; text-align: center; }
  .upload-card h1 { font-size: 26px; color: #1a73e8; margin-bottom: 10px; }
  .subtitle { font-size: 14px; color: #555; margin-bottom: 25px; }

  /* --- FORM --- */
  .upload-form { display: flex; flex-direction: column; gap: 20px; text-align: left; }
  .upload-form label { font-weight: 600; color: #333; }
  .upload-form select,
  .upload-form input[type="file"],
  .upload-form input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size: 14px; transition: 0.2s; width: 100%; }
  .upload-form select:focus,
  .upload-form input[type="file"]:focus,
  .upload-form input[type="text"]:focus { border-color: #1a73e8; box-shadow: 0 0 4px rgba(26,115,232,0.5); }

  .btn { background: #1a73e8; color: #fff; border: none; padding: 12px; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
  .btn:hover:not(:disabled) { background: #155ab6; }
  .btn:disabled { background: #999; cursor: not-allowed; }

  /* --- UPLOAD STATUS --- */
  .status { margin-top: 20px; font-size: 14px; color: #444; }
  .preview-container { margin-top: 10px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
  .preview-container img { max-width: 200px; border-radius: 6px; border: 1px solid #ddd; }
  .preview-container .file-name { font-size: 14px; color: #555; background: #f0f0f0; padding: 5px 10px; border-radius: 4px; }

  .wallet-section { margin-top: 20px; text-align: left; }
  .wallet-section button { width: 100%; margin-top: 10px; margin-bottom: 5px; }
  .wallet-address { margin-top: 10px; font-size: 14px; word-break: break-all; color: #333; background: #f0f0f0; padding: 10px; border-radius: 6px;}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="nav-container">
    <img src="./safeidlogo.jpg" alt="SafeID Logo" class="logo-img">
    <ul class="nav-links">
      <li><a href="../../../index.html">Home</a></li>
      <li><a href="../../../dashboard.html">Dashboard</a></li>
      <li><a href="../../../upload.html" class="active">Upload</a></li>
    </ul>
  </div>
</nav>

<!-- Upload Section -->
<section class="upload-section">
  <div class="upload-card">
    <h1 id="upload-title">ðŸ“¤ Upload Documents for <span id="refugee-name">[Refugee Name]</span></h1>
    <p class="subtitle">Securely upload documents and link them to the refugee's wallet.</p>

    <!-- Upload Form -->
    <form id="uploadForm" class="upload-form">
      <label for="docType">Select Document Type:</label>
      <select id="docType" name="docType" required>
        <option value="">--Select Document--</option>
        <option value="id_card">Identity Card</option>
        <option value="passport">Passport</option>
        <option value="certificate">Certificate</option>
        <option value="other">Other</option>
      </select>

      <label for="fileUpload">Choose File:</label>
      <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,.jpg,.jpeg,.png" required>

      <div id="uploadStatus" class="status"></div>
      <div class="preview-container" id="previewContainer"></div>
    </form>

    <!-- Wallet Linking -->
    <div class="wallet-section">
      <label>Link Refugee's Coinbase Wallet:</label>
      <button class="btn" id="connectWalletBtn">Connect Wallet</button>
      <div class="wallet-address" id="walletAddress" style="display: none;"></div>
    </div>

    <!-- Confirm Button -->
    <button class="btn" id="confirmBtn" disabled>Upload to IPFS & Go to Dashboard</button>
  </div>
</section>

<script type="module">
  // --- IMPORTS ---
  import axios from "https://cdn.jsdelivr.net/npm/axios@1.7.2/+esm";

  // --- CONFIGURATION ---
  const PINATA_JWT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI5ZjM4OTc3OS0yMWIzLTRkYWItYWNhZC0yOTRhMGY0Zjc0YzAiLCJlbWFpbCI6ImhhY2toYWNrYXRob242N0BnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwicGluX3BvbGljeSI6eyJyZWdpb25zIjpbeyJkZXNpcmVkUmVwbGljYXRpb25Db3VudCI6MSwiaWQiOiJGUkExIn0seyJkZXNpcmVkUmVwbGljYXRpb25Db3VudCI6MSwiaWQiOiJOWUMxIn1dLCJ2ZXJzaW9uIjoxfSwibWZhX2VuYWJsZWQiOmZhbHNlLCJzdGF0dXMiOiJBQ1RJVkUifSwiYXV0aGVudGljYXRpb25UeXBlIjoic2NvcGVkS2V5Iiwic2NvcGVkS2V5S2V5IjoiNjAyYjhiOTM3ZGE3ODhhMmI2NDgiLCJzY29wZWRLZXlTZWNyZXQiOiI0YWM0NDhhYTU4YTQxOGFhYWNhZTI3ZjQzOTQzMjViYjI0NjM4OGQwMGM3NDQ4OWUzOTcxZTQxYzk2YTE5MDRhIiwiZXhwIjoxNzg4MDUyNzE3fQ.9cpY0sGSWIwnVmdnxF0uYNrCzHi_FSRGw7wn2jER9cw';
  // Replace with your App ID from the Coinbase Developer Platform
  const COINBASE_APP_ID = 'd1a2b1fb-a597-4fd9-87db-0b4993b4bec3';

  // --- DOM ELEMENT REFERENCES ---
  const refugeeNameSpan = document.getElementById('refugee-name');
  const fileInput = document.getElementById('fileUpload');
  const docTypeSelect = document.getElementById('docType');
  const uploadStatus = document.getElementById('uploadStatus');
  const previewContainer = document.getElementById('previewContainer');
  const connectWalletBtn = document.getElementById('connectWalletBtn');
  const walletAddressDiv = document.getElementById('walletAddress');
  const confirmBtn = document.getElementById('confirmBtn');

  // --- STATE MANAGEMENT ---
  let walletAddress = '';
  let selectedFile = null;
  let coinbasePay = null;

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', () => {
    // Get refugee name from a previous page (e.g., the ID creation page)
    const urlParams = new URLSearchParams(window.location.search);
    const refugeeName = urlParams.get('name') || 'Refugee';
    refugeeNameSpan.textContent = refugeeName;
    
    initializeCoinbaseSDK();

    fileInput.addEventListener('change', handleFileSelect);
    connectWalletBtn.addEventListener('click', connectWallet);
    confirmBtn.addEventListener('click', handleConfirmAndUpload);
  });

  // --- FUNCTIONS ---

  /**
   * Initializes the Coinbase Embedded Wallet SDK.
   */
  function initializeCoinbaseSDK() {
    if (window.coinbasePay) {
        coinbasePay = new window.coinbasePay({
            appId: COINBASE_APP_ID,
            onSuccess: (response) => {
                walletAddress = response.address;
                walletAddressDiv.textContent = `Connected Wallet: ${walletAddress}`;
                walletAddressDiv.style.display = 'block';
                connectWalletBtn.textContent = 'Wallet Connected';
                connectWalletBtn.disabled = true;
                checkReadyState();
            },
            onError: (error) => console.error("Wallet connection failed:", error),
        });
    } else {
        console.error('Coinbase SDK not loaded.');
    }
  }

  /**
   * Opens the Coinbase wallet connection pop-up.
   */
  function connectWallet() {
    if (!coinbasePay) {
        alert('Coinbase SDK not initialized. Please refresh.');
        return;
    }
    coinbasePay.open({ experience: 'embedded' });
  }
  
  /**
   * Handles file selection and displays a preview.
   */
  function handleFileSelect() {
    previewContainer.innerHTML = '';
    selectedFile = fileInput.files[0];
    if (!selectedFile) return;

    // Display preview
    if (selectedFile.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(selectedFile);
      img.onload = () => URL.revokeObjectURL(img.src);
      previewContainer.appendChild(img);
    } else {
      const fileNameDiv = document.createElement('div');
      fileNameDiv.className = 'file-name';
      fileNameDiv.textContent = selectedFile.name;
      previewContainer.appendChild(fileNameDiv);
    }
    uploadStatus.textContent = `Selected: ${selectedFile.name}`;
    checkReadyState();
  }

  /**
   * Checks if both a file is selected and a wallet is connected to enable the confirm button.
   */
  function checkReadyState() {
    if (selectedFile && walletAddress) {
      confirmBtn.disabled = false;
    }
  }

  /**
   * Handles the final confirmation, uploads to IPFS, and redirects to the dashboard.
   */
  async function handleConfirmAndUpload() {
    if (!selectedFile || !walletAddress || !docTypeSelect.value) {
      alert("Please select a document type, choose a file, and connect a wallet.");
      return;
    }

    confirmBtn.textContent = 'Uploading to IPFS...';
    confirmBtn.disabled = true;

    try {
      const cid = await uploadToPinata(selectedFile, walletAddress, docTypeSelect.value);
      
      // On success, redirect to the dashboard with all necessary info
      const params = new URLSearchParams();
      params.set('name', refugeeNameSpan.textContent);
      params.set('wallet', walletAddress);
      params.set('cid', cid); // Add the new IPFS CID
      window.location.href = `../../../dashboard.html?${params.toString()}`;

    } catch (error) {
      alert(`Upload failed: ${error.message}`);
      confirmBtn.textContent = 'Upload to IPFS & Go to Dashboard';
      confirmBtn.disabled = false;
    }
  }

  /**
   * Uploads the selected file to IPFS via Pinata with structured naming.
   */
  async function uploadToPinata(file, wallet, docType) {
    const fileExtension = file.name.split('.').pop();
    const structuredFilename = `${wallet}_${docType}.${fileExtension}`;

    const data = new FormData();
    data.append('file', file);

    const metadata = JSON.stringify({
      name: structuredFilename,
      keyvalues: {
        refugeeWallet: wallet // Custom metadata to easily find all files for this wallet later
      }
    });
    data.append('pinataMetadata', metadata);
    
    console.log(`Uploading ${structuredFilename} to IPFS...`);

    try {
        const res = await axios.post("https://api.pinata.cloud/pinning/pinFileToIPFS", data, {
            headers: { 'Authorization': `Bearer ${PINATA_JWT}` }
        });
        console.log("Successfully stored on Pinata. CID:", res.data.IpfsHash);
        return res.data.IpfsHash;
    } catch (error) {
        console.error("Error uploading to Pinata:", error.response ? error.response.data : error);
        throw new Error("Failed to upload to IPFS. Check your Pinata JWT and permissions.");
    }
  }

</script>

</body>
</html>
